<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- <link rel="stylesheet" href="./style.css"> -->
    <style>
        body {
            background-color: rgb(2, 0, 8);
        }

        #canvasCol {
            background-color: rgb(233, 233, 233);
            padding: 5px 0 0 0;
            margin: 10px 0 0 0;
        }

        .menuCol {
            background-color: rgb(192, 192, 192);
            margin-top: 10px;
        }
    </style>
    <title>Animação HTML</title>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">

            <div id="canvasCol" class="col text-center">
                <canvas id="gameCanvas" width="900" height="500"></canvas>
            </div>

        </div>

        <div class="row justify-content-center">
            <div class="col noGap menuCol">
                <div class="row">
                    <div class="col col-md-8 col-lg-5">
                        <label id="speedLabel" for="speedRange" class="form-label m-0">Velocidade:</label>
                        <input type="range" min="0" max="4" value="1" step="0.25" class="form-range" id="speedRange">
                    </div>
                </div>


                <div class="row">
                    <div class="col">
                        <p id="fpsLabel" class="noGap">FPS: 0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="./script.js"></script> -->
    <script>
        let canvas = document.getElementById("gameCanvas");
        let builder = canvas.getContext("2d");

        let sceneSpeed = 1;

        let sunAngle = 0; //comeca em cima
        let sunSpeed = 1;

        let nightR = 6, nightG = 15, nightB = 34;
        let dayR = 185, dayG = 248, dayB = 255;

        let R = dayR
        let G = dayG;
        let B = dayB;


        //Para calcular FPS
        let frameCount = 0;
        let markedTime = new Date().getTime();
        let FPS = 0;

        function loop() {
            setCanvasSize();
            sceneSpeed = document.getElementById("speedRange").value;
            document.getElementById("speedLabel").innerText = "Velocidade: x" + sceneSpeed;

            //Para calcular FPS
            frameCount++;
            let now = new Date().getTime();
            if (now - markedTime >= 1000) {
                FPS = frameCount;
                markedTime = new Date().getTime();
                frameCount = 0;
            }

            document.getElementById("fpsLabel").innerText = "FPS: " + FPS
                + ", angulo do sol: " + sunAngle.toFixed(2);



            //_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
            builder.clearRect(0, 0, 900, 500);

            drawSky();

            drawSun();

            drawGrass();

            requestAnimationFrame(loop);
        }

        function drawSky() {
            builder.beginPath();
            builder.rect(0, 0, canvas.offsetWidth, 70 * canvas.offsetHeight / 100);

            let sunSetStart = 20;
            let sunSetEnd = 95;
            const sunSetSpan = (sunSetEnd - sunSetStart);

            let sunRiseStart = 265;
            let sunRiseEnd = 360;
            const sunRiseSpan = (sunRiseEnd - sunRiseStart);

            if (isBetween(sunAngle, sunSetStart, sunSetEnd)) {
                setNextSkyColor(sunSetSpan, false);
            }
            else if (isBetween(sunAngle, sunRiseStart, sunRiseEnd)) {
                setNextSkyColor(sunRiseSpan, true);
            }

            builder.fillStyle = "rgb(" + R + ", " + G + ", " + B + ")";
            builder.fill();
            builder.closePath();
        }

        function isBetween(value, start, end) {
            return value >= start && value <= end;
        }

        function setNextSkyColor(transitionSpan, isRising) {
            let rStep = (dayR - nightR) / transitionSpan * sunSpeed * sceneSpeed;
            let gStep = (dayG - nightG) / transitionSpan * sunSpeed * sceneSpeed;
            let bStep = (dayB - nightB) / transitionSpan * sunSpeed * sceneSpeed;

            if (isRising) {
                R = (R < dayR ? R + rStep : R - rStep);
                G = (G < dayG ? G + gStep : G - gStep);
                B = (B < dayB ? B + bStep : B - bStep);
            }
            else {
                R = (R < nightR ? R + rStep : R - rStep);
                G = (G < nightG ? G + gStep : G - gStep);
                B = (B < nightB ? B + bStep : B - bStep);
            }
        }

        function drawGrass() {
            let floorHeight = 70 * canvas.offsetHeight / 100;
            builder.beginPath();
            builder.rect(0, floorHeight, canvas.offsetWidth, canvas.offsetHeight - floorHeight);
            builder.fillStyle = "green";
            builder.fill();
            builder.closePath();
        }

        function drawSun() {
            //Salva orientação atual
            builder.save();
            //posiciona centro do circulo na metade da largura, e na altura total
            builder.translate(canvas.offsetWidth / 2, canvas.offsetHeight);

            //rotaciona todo o canvas
            var X_Radians = Math.PI / 180 * sunAngle;
            builder.rotate(X_Radians);

            //move o ponto inicial do desenho
            builder.translate(0, -canvas.offsetWidth / 2);//(raio)
            builder.fillStyle = "yellow";


            //desenha o sol
            builder.beginPath();
            builder.arc(0, 0, 5.5 * canvas.offsetWidth / 100, 0, 2 * Math.PI);
            builder.closePath();
            builder.fill();
            builder.restore();
            sunAngle += sunSpeed * sceneSpeed;

            if (sunAngle >= 360) sunAngle = 0;
        }

        function setCanvasSize() {
            let canvasCol = document.getElementById("canvasCol");

            let maxHeight = 80 * window.innerHeight / 100;
            let maxWidth = maxHeight * 2;
            let minWidth = 500;
            let newCanvasWidth;

            if (canvasCol.offsetWidth >= maxWidth) newCanvasWidth = maxWidth;
            else if (canvasCol.offsetWidth < minWidth) newCanvasWidth = minWidth;
            else newCanvasWidth = canvasCol.offsetWidth;

            canvas.setAttribute("width", newCanvasWidth);
            canvas.setAttribute("height", Math.floor(50 * newCanvasWidth / 100));
        }

        loop();
    </script>





    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
</body>

</html>